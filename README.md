# FoxTrail 行程规划平台

FoxTrail 仓库现在包含一个可运行的全栈原型（React + Express）以及完整的产品与技术蓝图文档，帮助团队从概念、体验到实现快速对齐。

## 可运行原型简介

### 功能亮点
- 行程总览与详情：在单页应用中浏览、选择与删除行程活动，查看 AI 摘要、共享链接与协作信息。
- 活动维护：通过表单新增活动，自动与后端同步，支持一键按时间顺序优化。
- AI 行程生成：填写目的地、天数与关注主题后，调用服务器的模拟 AI 服务生成多日安排。
- 日历同步演示：支持模拟同步到外部日历，展示提醒功能的触达时间。
- 数据持久化：后端将行程保存在 JSON 数据文件中，首次启动会写入示例「京都学习之旅」。

### 快速开始
1. 安装依赖：`npm install`（会同时安装 client 与 server）。
2. 启动开发环境：`npm run dev`，前端默认运行在 <http://localhost:5173>，后端 API 在 <http://localhost:4000>。
3. 生产构建：`npm run build` 输出前端静态资源，可配合 `npm run start --prefix server` 启动后端服务。

> 如果前端需要连接部署在其他地址的 API，可在 client 根目录创建 `.env` 并配置 `VITE_API_BASE_URL`。

### API 速览
| Method | Path | 说明 |
| --- | --- | --- |
| GET | `/api/itineraries` | 获取全部行程列表 |
| POST | `/api/itineraries` | 新建行程 |
| GET | `/api/itineraries/:id` | 查看指定行程 |
| POST | `/api/itineraries/:id/items` | 为行程新增活动 |
| DELETE | `/api/itineraries/:id/items/:itemId` | 删除活动 |
| POST | `/api/itineraries/:id/optimize` | 将活动按时间顺序排序 |
| POST | `/api/itineraries/:id/sync` | 模拟同步到外部日历 |
| POST | `/api/itineraries/generate` | 触发 AI（模拟）生成行程 |

---

## 产品与技术蓝图

本文档汇总了 FoxTrail 行程规划平台的整体产品与技术方案，面向学生、旅行者与通勤者等目标用户，涵盖核心能力、系统设计、数据模型、技术栈、用户流程以及部署建议等十大方面。

### 1. 核心功能模块概览
# FoxTrail 行程规划平台方案

本文档汇总了 FoxTrail 行程规划平台的整体产品与技术方案，面向学生、旅行者与通勤者等目标用户，涵盖核心能力、系统设计、数据模型、技术栈、用户流程以及部署建议等十大方面。

- **智能路线建议**：根据用户输入的多个地点、行程日程或任务要求，自动规划最优路线与交通方式（驾车、公共交通、步行等），输出换乘方案与预计到达时间。例如：
  - 通勤场景下给出最快的上下班路线。
  - 旅行者输入多景点后，生成合理的游览顺序与交通安排。
- **日历同步**：与 Google Calendar 等主流日历服务打通，支持导入、导出与实时同步。提供日历订阅或 Webhook，当外部日程变更时自动更新平台内行程，保持信息一致。
- **AI 行程生成**：内置 AI 行程助手，依据用户的目的地、时间、预算与兴趣偏好自动生成行程，结合天气、活动等实时数据提供创意与可执行的方案。
- **行程协作与分享**：允许多人协同编辑，通过邀请链接或权限控制共享行程，可一键分享到社交平台或导出为 PDF/图片等静态内容。
- **通知提醒**：依据行程节点推送提醒（如出发通知、航班/会议提醒、实时交通建议），通过邮件、短信或应用内推送确保不错过关键事件。
- **其他辅助功能**：行程模板库、费用预算与报销管理、游记记录等附加能力，帮助用户快速套用方案、记录花费并沉淀旅途记忆。

### 2. 完整的系统架构设计

系统采用前后端分离、RESTful 通信的分层架构：

- **前端（React SPA）**：
  - 使用 React 构建单页应用，承担行程编辑拖拽、地图展示、日历视图等交互。
  - 通过 Axios/Fetch 调用后端 API，并可直接集成地图 SDK（Google Maps、高德等）在页面上渲染路线与标记。
- **后端（Node.js 服务）**：
  - 采用 Express/NestJS 构建 REST API，负责用户认证、行程管理、AI 调用等业务逻辑。
  - 模块化拆分行程、用户、AI 等子系统，统一封装对第三方服务的访问。
  - 支持缓存与异步任务（如 AI 调用）提升性能，并处理日历 Webhook 等回调。
- **数据库层**：
  - 以 MongoDB 为主存储用户、行程、行程项、偏好与 OAuth 令牌等信息。
  - 结合 Redis 等缓存热点数据，如热门景点、城市信息。
- **第三方服务**：
  - 地图服务（路线规划、POI 数据）、日历服务（Google Calendar、Microsoft Outlook 等）、AI 大模型（OpenAI GPT-4 等），以及天气、交通、社交分享 API。

此架构具备良好的水平扩展性，后续可逐步演进为微服务体系，初期则以模块化单体简化复杂度。

### 3. 数据库设计方案

**数据库选型：** 采用 MongoDB 文档型数据库，以 BSON 文档存储行程及其子项。若未来需要强约束，可迁移至关系型数据库。

**核心集合：**

- `Users`
  - 字段：`_id`、`email`（唯一索引）、`passwordHash`、`name`、`preferences`、`oauthTokens` 等。
  - 关系：与 `Itineraries` 为一对多。
- `Itineraries`
  - 字段：`_id`、`userId`、`title`、`type`（旅行/日常/通勤等）、`startDate`、`endDate`、`sharedWith`、`createdAt`、`updatedAt` 等。
  - 关系：通过 `userId` 关联 `Users`，并可包含协作用户列表。
- `ItineraryItems`
  - 字段：`_id`、`itineraryId`、`name`、`category`、`location`、`startTime`、`endTime`、`details`、`referenceId` 等。
  - 关系：通过 `itineraryId` 关联 `Itineraries`，可根据需求设计为嵌套子文档或独立集合。
- 可选集合：`Places`（地点库）、`Notifications`（提醒计划）、`Files`（附件）、`Logs`（操作/AI 日志）等。

通过引用实现关联关系，并利用索引优化按用户、日期或类型的查询。若采用关系型数据库，可建立对应表及外键，并绘制 ER 图表示 `Users` 1-* `Itineraries`、`Itineraries` 1-* `ItineraryItems` 等关系。

### 4. 技术选型

- **前端：** React + React Router 构建 SPA，结合 Ant Design / Material UI 等组件库，Redux 或 Context 管理复杂状态，CSS-in-JS 或 SASS 统一样式。支持地图组件（Google Maps JS、高德等）与 FullCalendar 等日历组件。
- **后端：** Node.js 平台，使用 Express 或 NestJS 构建 REST API；Axios/node-fetch 访问外部服务；Passport.js 等实现认证；必要时使用 Socket.IO 实现实时协作；推荐使用 TypeScript 提升可维护性。
- **数据库：** MongoDB + Mongoose ODM，生产环境使用 MongoDB Atlas，缓存层可接入 Redis。
- **地图与位置服务：** Google Maps API（Directions、Places、Maps JS）或高德/百度等本地化方案；Mapbox + OpenStreetMap 作为备选。
- **日历集成：** Google Calendar API（OAuth2 授权、事件同步、Push 通知）；可扩展到 Microsoft Graph 等；支持导出 ICS。
- **AI 推荐：** OpenAI GPT-4 API 为主，备选 Claude、PaLM 等；可使用任务队列调度 AI 调用并缓存结果。
- **其他服务：** 天气（OpenWeatherMap）、交通实时数据、消息推送（SendGrid、Twilio 等）、社交分享等。
- **开发与部署工具：** Git 版本管理，Jest/Cypress 等测试框架，GitHub Actions 持续集成，Webpack 或 Vite 构建前端，Babel/TS 编译后端。


### 5. 用户流程图（文字描述）

1. **注册与登录**：新用户注册账号或使用 OAuth 登录，首次登录可查看新手引导。
2. **个人设置**：完善个人资料、常用地点与交通偏好，绑定外部日历账户。
3. **创建新行程**：选择行程类型（旅行/日常/通勤），填写目的地、日期、任务或偏好信息。
4. **AI 行程生成**：提交后触发 AI 生成行程草案，前端展示加载状态。
5. **用户调整行程**：在可视化界面调整顺序、时间与地点，地图实时更新，多人协作可同步编辑。
6. **保存行程**：确认后保存至数据库，可生成分享链接或导出静态文件。
7. **日历同步**：一键同步至外部日历或导入外部事件，保持双向一致。
8. **通知与执行**：依据行程自动推送提醒，用户可查看导航、标记任务完成。
9. **分享与反馈**：行程结束后生成游记、反馈满意度，优化个性化推荐。

### 6. 模块之间的连接与接口逻辑

- **前端 ⇄ 后端**：采用 RESTful API 或 GraphQL，统一使用 JSON 数据格式，典型接口包括注册登录、行程 CRUD、AI 生成触发等。使用 JWT 等方式验证身份；长耗时任务可通过 WebSocket/SSE 推送结果。
- **后端 ⇄ 数据库**：业务服务调用 Mongoose 模型执行 CRUD，必要时使用事务保障行程与子项的原子更新，并对 `userId`、日期等字段建立索引。
- **后端 ⇄ 地图服务**：通过 Directions/Places 等 API 获取路线、换乘和地点详情，可在后端合并处理或部分交由前端直接调用。
- **后端 ⇄ 日历服务**：利用 OAuth2 令牌访问 Google Calendar 等接口，实现事件同步、更新与删除；通过 Webhook 接受外部日程变更并更新本地数据。
- **后端 ⇄ AI 服务**：封装对 GPT-4 等模型的调用，使用异步任务队列与超时重试机制，必要时将结果缓存并过滤异常输出。
- **前端 ⇄ 实时通讯（可选）**：通过 Socket.IO/WebSocket 在协作编辑和实时提醒场景下实现消息广播，后端需做权限校验与连接管理。

### 7. 高保真功能流程示例：AI 自动生成旅行行程

1. 用户在前端填写目的地、天数、偏好等信息并提交。
2. 前端发送 `POST /api/itineraries/generate` 请求，进入加载状态。
3. 后端构造 Prompt，汇总本地与第三方信息（如天气、节庆）后调用 OpenAI API。
4. AI 返回行程草案，后端校验并可结合地图 API 补充路线距离与时间，必要时调整顺序。
5. 后端将整理后的行程草案写入数据库，并通过 API 响应或 WebSocket 推送给前端。
6. 前端渲染每日时间轴、地图路线与活动详情，用户可继续编辑或重新生成。
7. 用户确认后保存为正式行程，后续可执行日历同步与提醒功能。

### 8. 可行性评估与潜在风险分析

- **技术可行性**：React、Node.js、MongoDB、Google Maps、OpenAI 等生态成熟，配合云托管可快速构建 MVP 并逐步扩展。
- **市场可行性**：整合旅行与日常行程规划的需求广泛，AI 辅助降低使用门槛，有望获得学生、旅行者与通勤者青睐。
- **潜在风险**：
  - 第三方依赖：地图、AI、日历 API 费用与稳定性风险，需要调用限流与备选方案。
  - 数据隐私安全：加强身份验证、加密敏感数据、遵循 GDPR 等隐私法规。
  - AI 内容可靠性：对生成结果进行校验与后处理，允许用户反馈纠错。
  - 开发复杂度：多领域集成带来实施难度，应采用敏捷迭代与模块化架构。
  - 性能与体验：AI/地图调用耗时需优化，并提供异步通知以防等待过长。
  - 竞争压力：与谷歌、Citymapper 等现有产品差异化定位，突出本地化与全场景整合优势。

### 9. 同类竞品平台调研

- **TripIt**：擅长解析预订邮件自动生成旅行行程，支持日历同步与分享。可借鉴其自动化整理与提醒功能。
- **Funliday**：面向繁体中文市场的智能旅行规划 App，提供 AI 自动排旅程、协同编辑、费用记账等功能，是我们旅行模块的重要参考。
- **Wanderlog**：地图驱动的旅行规划工具，突出地图与每日列表的结合，值得在界面设计上借鉴。
- **Google Calendar + Google Maps**：用户常用的组合，但缺乏一体化体验。FoxTrail 通过时间与空间一站式整合形成差异化。
- **Citymapper 等通勤应用**：提供精准的实时公共交通建议，提醒我们在通勤模块上需强化本地数据与实时能力。

### 10. 初步部署建议

- **本地开发**：推荐使用 Docker Compose 管理前端、后端、MongoDB，结合热更新与 .env 配置统一环境。
- **CI/CD**：使用 GitHub Actions 自动执行测试与构建，确保关键分支稳定后再部署。
- **前端部署**：构建后的静态资源部署到 Vercel/Netlify 或国内 OSS+CDN，支持自定义域名与 HTTPS。
- **后端部署**：选择 Railway、Render、Heroku 等 PaaS 平台或自建云主机，配置环境变量并启用 HTTPS。
- **数据库**：使用 MongoDB Atlas 托管生产数据库，设置访问控制与备份策略，区分开发与生产环境。
- **域名与路由**：绑定自定义域名（如 example.com），API 可使用子域或反向代理统一入口。
- **环境配置**：通过环境变量安全管理 API 密钥与 OAuth 凭据，避免在前端暴露敏感信息。
- **监控与扩容**：集成日志与异常监控（Sentry、Papertrail），根据用户增长启用水平扩展、队列与缓存；为数据库与服务预留备份与扩展方案。

---

该方案为 FoxTrail 的整体蓝图，可在此基础上优先实现 MVP，并按照风险与价值逐步迭代功能模块。
